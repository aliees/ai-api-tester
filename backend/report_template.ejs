<!DOCTYPE html>
<html>
<head>
  <title>Test Report</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #333; }
    .summary { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; }
    .test-case { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; }
    .passed { border-left: 5px solid #28a745; }
    .failed { border-left: 5px solid #dc3545; }
    pre { background-color: #f5f5f5; padding: 10px; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>API Test Report</h1>
  <div class="summary">
    <h2>Summary</h2>
    <p>Total Tests: <%= report.totalTests %></p>
    <p>Passed: <%= report.passed %></p>
    <p>Failed: <%= report.failed %></p>
    <p>Average Response Time: <%= report.averageResponseTime %>ms</p>
    <img src="<%= chartImage %>" alt="Test Results Chart">
  </div>
  
  <h2>Test Cases</h2>
  <% testCases.forEach(testCase => { %>
    <div class="test-case <%= testCase.passed ? 'passed' : 'failed' %>">
      <h3><%= testCase.description %></h3>
      <button class="copy-curl-button" data-test-case="<%= JSON.stringify(testCase) %>">Copy cURL</button>
      <p><strong>URL:</strong> <%= testCase.url %></p>
      <p><strong>Method:</strong> <%= testCase.method %></p>
      <p><strong>Status:</strong> <%= testCase.status %></p>
      <p><strong>Response Time:</strong> <%= testCase.responseTime %>ms</p>
      <h4>Request</h4>
      <pre><code><strong>Headers:</strong><br><%= JSON.stringify(testCase.headers, null, 2) %></code></pre>
      <pre><code><strong>Body:</strong><br><%= JSON.stringify(testCase.payload, null, 2) %></code></pre>
      <div class="accordion">
        <div class="accordion-header">
          <h4>Response</h4>
          <button class="accordion-button">View Full Response</button>
        </div>
        <div class="accordion-body" style="display: none;">
          <pre><code><%= JSON.stringify(testCase.response, null, 2) %></code></pre>
        </div>
      </div>
    </div>
  <% }); %>

</body>
<script>
  const generateCurl = (testCase) => {
    let curl = `curl --location --request ${testCase.method} '${testCase.url}'`;

    if (testCase.headers) {
      const headers = JSON.parse(testCase.headers);
      for (const key in headers) {
        curl += ` \\\n--header '${key}: ${headers[key]}'`;
      }
    }

    if (testCase.payload) {
      curl += ` \\\n--data-raw '${testCase.payload}'`;
    }

    return curl;
  };

  document.querySelectorAll('.accordion-button').forEach(button => {
    button.addEventListener('click', () => {
      const accordionBody = button.parentElement.nextElementSibling;
      if (accordionBody.style.display === 'none') {
        accordionBody.style.display = 'block';
        button.textContent = 'Hide Full Response';
      } else {
        accordionBody.style.display = 'none';
        button.textContent = 'View Full Response';
      }
    });
  });

  document.querySelectorAll('.copy-curl-button').forEach(button => {
    button.addEventListener('click', () => {
      const testCase = JSON.parse(button.dataset.testCase);
      const curlCommand = generateCurl(testCase);
      navigator.clipboard.writeText(curlCommand);
    });
  });
</script>
</html>