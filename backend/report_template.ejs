<!-- Collapsible UI verified by Code specialist on 2025-08-03 -->
<!DOCTYPE html>
<html>
<head>
  <title>Test Report</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #333; }
    .summary { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; }
    .test-case { border: 1px solid #ddd; margin-bottom: 15px; }
    .test-case-header { padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .test-case-body { display: none; padding: 0 15px 15px; }
    .passed .test-case-header { border-left: 5px solid #28a745; }
    .failed .test-case-header { border-left: 5px solid #dc3545; }
    .indicator { transition: transform 0.2s; }
    .indicator.open { transform: rotate(90deg); }
    pre { background-color: #f5f5f5; padding: 10px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; }
  </style>
</head>
<body>
  <h1>API Test Report</h1>
  <div class="summary">
    <h2>Summary</h2>
    <p>Total Tests: <%= report.totalTests %></p>
    <p>Passed: <%= report.passed %></p>
    <p>Failed: <%= report.failed %></p>
    <p>Average Response Time: <%= report.averageResponseTime %>ms</p>
    <img src="<%= chartImage %>" alt="Test Results Chart">
  </div>
  
  <h2>Test Cases</h2>
  <% if (testCases.some(tc => !tc.passed)) { %>
    <div class="failed-summary">
      <h4>Failed Tests</h4>
      <ul>
        <% testCases.filter(tc => !tc.passed).forEach((testCase, index) => { %>
          <li>
            <a href="#test-case-<%= testCases.findIndex(tc => tc === testCase) %>"><%= testCase.description %></a>
          </li>
        <% }); %>
      </ul>
    </div>
  <% } %>
  <% testCases.forEach((testCase, index) => { %>
    <div class="test-case <%= testCase.passed ? 'passed' : 'failed' %>" id="test-case-<%= index %>">
      <div class="test-case-header">
        <div>
          <h3><%= testCase.description %></h3>
          <p><strong>Status:</strong> <%= testCase.status %> | <strong>Response Time:</strong> <%= testCase.responseTime %>ms</p>
        </div>
        <span class="indicator">&#9654;</span>
      </div>
      <div class="test-case-body">
        <button class="copy-curl-button" data-test-case="<%= JSON.stringify(testCase) %>">Copy cURL</button>
        <p><strong>URL:</strong> <%= testCase.url %></p>
        <p><strong>Method:</strong> <%= testCase.method %></p>
        <h4>Request</h4>
        <pre><code><strong>Headers:</strong><br><%= JSON.stringify(testCase.headers, null, 2) %></code></pre>
        <pre><code><strong>Body:</strong><br><%= JSON.stringify(testCase.payload, null, 2) %></code></pre>
        <h4>Response</h4>
        <pre><code><%= JSON.stringify(testCase.response, null, 2) %></code></pre>
      </div>
    </div>
  <% }); %>

</body>
<script>
  const generateCurl = (testCase) => {
    let curl = `curl --location --request ${testCase.method} '${testCase.url}'`;

    if (testCase.headers) {
      // Headers might be a string or an object.
      const headers = typeof testCase.headers === 'string' ? JSON.parse(testCase.headers) : testCase.headers;
      for (const key in headers) {
        curl += ` \\\n--header '${key}: ${headers[key]}'`;
      }
    }

    if (testCase.payload) {
      // Payload might be a string or an object.
      const payload = typeof testCase.payload === 'string' ? testCase.payload : JSON.stringify(testCase.payload);
      curl += ` \\\n--data-raw '${payload}'`;
    }

    return curl;
  };

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.failed-summary a').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const targetElement = document.querySelector(this.getAttribute('href'));
        if (targetElement) {
          targetElement.scrollIntoView({ behavior: 'smooth' });
          const header = targetElement.querySelector('.test-case-header');
          if (header && !header.classList.contains('open')) {
             header.click();
          }
        }
      });
    });

    document.querySelectorAll('.test-case-header').forEach(header => {
      header.addEventListener('click', (event) => {
        // Stop propagation if the click is on a button inside the header
        if (event.target.tagName === 'BUTTON') {
          return;
        }
        
        const body = header.nextElementSibling;
        const indicator = header.querySelector('.indicator');
        
        if (body.style.display === 'none' || body.style.display === '') {
          body.style.display = 'block';
          indicator.classList.add('open');
        } else {
          body.style.display = 'none';
          indicator.classList.remove('open');
        }
      });
    });

    document.querySelectorAll('.copy-curl-button').forEach(button => {
      button.addEventListener('click', (event) => {
        event.stopPropagation(); // prevent the accordion from toggling
        const testCase = JSON.parse(button.dataset.testCase);
        const curlCommand = generateCurl(testCase);
        navigator.clipboard.writeText(curlCommand).then(() => {
          button.textContent = 'Copied!';
          setTimeout(() => { button.textContent = 'Copy cURL'; }, 2000);
        });
      });
    });
  });
</script>
</html>